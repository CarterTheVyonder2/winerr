<!DOCTYPE html>
<html lang="((lang))">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>((title))</title>
    <script src="pako.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="/win1.png" type="image/png">
    <style>
        body {
            margin: 8px;
        }
    </style>
</head>

<body>
    <div class="winerr-settings">
        <select id="lang-select" onchange='
    
        let langElem = document.querySelector("#lang-select");
        let chosenLang = langElem.value;
        document.cookie=`winerrLang=${chosenLang}`;
        location.reload();
            '>
            <option value="en">English</option>
            <option value="es">Espa√±ol</option>
            <option value="ro">Rom√¢nƒÉ</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
        </select>
        <div class="wlg-wrapper">
            <input type="checkbox" id="wlg" name="wlg" checked>
            <label for="wlg">((legacy))</label>
        </div>
    </div>
    <div id="space"></div>
    <div class="os-selector">
        <label for="os">((os-select)):</label>
        <select id="os" name="os">
            <option value="win1">Windows 1.0/2.0</option>
            <option value="win31">Windows 3.1</option>
            <option value="win95">Windows 95</option>
            <option value="win98">Windows 98</option>
            <option value="win2k">Windows 2000</option>
            <option value="winwh">Windows Whistler</option>
            <option value="winxp">Windows XP</option>
            <option value="winlh-4093">Windows Longhorn build 4093</option>
            <option value="winvista">Windows Vista/7 (Basic)</option>
            <option value="win7">Windows Vista/7 (Aero)</option>
            <option value="win8">Windows 8/8.1</option>
            <option value="win10">Windows 10</option>
            <option value="win11">Windows 11</option>
        </select>
    </div>
    <br>
    <div class="error-msg">
        <canvas id="canvas" width="0" height="0"></canvas>
        <canvas id="test-canvas" width="0" height="0"></canvas><br><br>
        <span class="error-txt"></span>
        <a class="dl" style="display:none;cursor:pointer;" target="_blank">üì• ((dl-btn))</a>
    </div>
    <div class="direct-link"></div>
    <br>
    <span class="cross-wrapper"></span>
    <label for="err-title">((err-title)):</label><br>
    <input type="text" id="err-title" name="err-title">
    <br>
    <label for="err-desc">((err-content)):</label><br>
    <textarea type="text" id="err-desc" name="err-desc"></textarea>
    <br>
    <label for="icon">((icon-id)):</label><br>
    <input type="number" id="icon" min="1" max="405" value="1"> <small><a href="/winerr/icons">((icon-ids))</a></small>
    <br>
    <div class="btns">
        <div class="btn1">
            <label for="btn1">((btn1)):</label><br>
            <input type="text" id="btn1" name="btn1">

            <input type="checkbox" id="btn1-dis" name="btn1-dis">
            <label for="btn1-dis">((btn-disabled))</label>

            <input type="checkbox" id="btn1-rec" name="btn1-rec">
            <label for="btn1-rec">((btn-recommended))</label>
        </div>
        <div class="btn2">
            <label for="btn2">((btn2)):</label><br>
            <input type="text" id="btn2" name="btn2">

            <input type="checkbox" id="btn2-dis" name="btn2-dis">
            <label for="btn2-dis">((btn-disabled))</label>

            <input type="checkbox" id="btn2-rec" name="btn2-rec">
            <label for="btn2-rec">((btn-recommended))</label>
        </div>
        <div class="btn3">
            <label for="btn3">((btn3)):</label><br>
            <input type="text" id="btn3" name="btn3">

            <input type="checkbox" id="btn3-dis" name="btn3-dis">
            <label for="btn3-dis">((btn-disabled))</label>

            <input type="checkbox" id="btn3-rec" name="btn3-rec">
            <label for="btn3-rec">((btn-recommended))</label>
        </div>
    </div>
    <br>
    <span class="gradient-selectors">
    </span>
    <span class="clr">
        <div class="color"></div>
    </span>
    <button class="generate">((btn-generate))</button>
    <script>
        const wlgCheckbox = document.querySelector("#wlg");
        wlgCheckbox.addEventListener("click", () => {
            const expirationDate = new Date();
            expirationDate.setFullYear(expirationDate.getFullYear() + 100);
            document.cookie = `wlg=0; expires=${expirationDate.toUTCString()}; path=/`;
            location.reload();
        })
    </script>
    <script>
        let version = `((version))`;
        let iconsLength = Number(`((icons-length))`);
        let translatedKeys = { "x-dis": "((x-dis))", "frame-color": "((frame-color))", "btn-generate": "((btn-generate))", "loading": "((loading))", "check-internet-connection": "((check-internet-connection))", "gradient-primary": "((gradient-primary))", "gradient-sec": "((gradient-sec))" }
        let generate = document.querySelector(".generate");
        generate.innerHTML = "((loading-assets))";
        generate.disabled = true;

        let systems = {};
        let fonts = {};
        let assetsArray = {};
        let testBitmaps;
        let isCJ;
        let sysFontObj;
        let sys = document.querySelector("#os");
        let savedVersion = localStorage.getItem("version");
        async function load() {
            let gzipRes = '';
            let iconsGzip = "";
            if (savedVersion != version) {
                let receivedLength = 0;
                const reqResources = await fetch("/resources");
                reader = reqResources.body.getReader();

                receivedLength = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    receivedLength += value.length;
                    const percentage = ((receivedLength / iconsLength) * 100).toFixed(2);
                    gzipRes += new TextDecoder().decode(value);
                    generate.innerHTML = `${"((loading-assets))".replace("...", "")}: ${(receivedLength / 1048576).toFixed(2)} MB / ${(iconsLength / 1048576).toFixed(2)} MB (${percentage}%)`;
                }

                localStorage.setItem("fonts", gzipRes.split("~")[1]);
                localStorage.setItem("sysInfo", gzipRes.split("~")[2]);
                localStorage.setItem("version", version);

                iconsGzip = gzipRes.split("~")[0]

                const request = indexedDB.open("assetsdb", 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    let objectStore = db.createObjectStore("assets");
                    objectStore.createIndex("assets", "assets");

                    objectStore.transaction.oncomplete = (event) => {
                        const objStore = db
                            .transaction("assets", "readwrite")
                            .objectStore("assets");
                        objStore.add(iconsGzip, "assets");
                    };
                }
            } else {
                async function loadIcons() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open("assetsdb");

                        request.onsuccess = function (event) {
                            const db = event.target.result;

                            const transaction = db.transaction(["assets"], "readonly");
                            const objectStore = transaction.objectStore("assets");
                            const getRequest = objectStore.get("assets");

                            getRequest.onsuccess = function (event) {
                                const gz = event.target.result;
                                resolve(gz);
                            };

                            getRequest.onerror = function (event) {
                                reject(event.target.error);
                            };
                        };

                        request.onerror = function (event) {
                            reject(event.target.error);
                        };
                    });
                }

                iconsGzip = await loadIcons();
            }
            const sysInfoGzip = localStorage.getItem("sysInfo");
            const assetsObjGzip = iconsGzip;
            const fontsObjGzip = localStorage.getItem("fonts");
            generate.innerHTML = "((extracting-assets))";

            const gzippedSysData = atob(sysInfoGzip);
            const sysDataArray = Uint8Array.from(gzippedSysData, c => c.charCodeAt(0));
            let sysString = new TextDecoder().decode(pako.ungzip(sysDataArray));

            for (const os of sysString.split("|")) {
                const split = os.split("~");
                const toBoolean = {
                    "0": false,
                    "1": true
                };
                if (!split[0]) continue;
                systems[split[0]] = {
                    button3Allowed: toBoolean[split[1]],
                    cross: toBoolean[split[2]],
                    gradient: toBoolean[split[3]],
                    recolor: toBoolean[split[4]]
                };
            }

            const gzippedAssetsData = atob(assetsObjGzip);
            const assetsDataArray = Uint8Array.from(gzippedAssetsData, c => c.charCodeAt(0));
            let assetsStr = new TextDecoder().decode(pako.ungzip(assetsDataArray));

            for (const os of assetsStr.split(";")) {
                const split = os.split("~:~");
                if (!split[0]) continue;
                assetsArray[split[0]] = {};
                let assets = {};
                for (let asset of split[1].split("|")) {
                    if (asset.split(":")[0] == "src") {
                        assetsArray[split[0]].src = asset.split(":")[1];
                        continue;
                    }
                    const coords = asset.split(":")[1].split("~");
                    assets[asset.split(":")[0]] = {
                        x: Number(coords[0]),
                        y: Number(coords[1]),
                        w: Number(coords[2]),
                        h: Number(coords[3])
                    };
                }
                assetsArray[split[0]].assets = assets;
            }

            const gzippedFontsData = atob(fontsObjGzip);
            const fontsDataArray = Uint8Array.from(gzippedFontsData, c => c.charCodeAt(0));
            let fontsStr = new TextDecoder().decode(pako.ungzip(fontsDataArray));

            for (const font of fontsStr.split(",")) {
                const split = font.split("[");
                if (!split[0]) continue;
                fonts[split[0]] = {};
                for (const style of split[1].split("~:~")) {
                    const styleSplit = style.split("~|~");
                    if (!styleSplit[0]) continue;
                    fonts[split[0]][styleSplit[0]] = {};

                    for (const color of styleSplit[1].split("~;~")) {
                        const colorSplit = color.split("|");
                        if (!colorSplit[0]) continue;
                        fonts[split[0]][styleSplit[0]][colorSplit[0]] = {};
                        let colorAssets = {};

                        for (const asset of colorSplit) {
                            if (!asset.includes(":")) continue;
                            const assetSplit = asset.split(":");
                            if (assetSplit[0] == "src") {
                                fonts[split[0]][styleSplit[0]][colorSplit[0]].src = asset.split(":")[1].split("~")[0];
                                continue;
                            }

                            const coords = assetSplit[1].split("~");
                            colorAssets[assetSplit[0]] = {
                                x: Number(coords[0]),
                                y: Number(coords[1]),
                                w: Number(coords[2]),
                                h: Number(coords[3])
                            }
                        }

                        fonts[split[0]][styleSplit[0]][colorSplit[0]].info = colorAssets;
                    }
                }
            }
        }
        load().then(() => {
            generate.innerHTML = "((btn-generate))";
            generate.disabled = false;

            sysFontObj = {
                "win1": "Fixedsys",
                "win31": "MSSansSerif",
                "win95": "MSSansSerif",
                "winmem": "MSSansSerif",
                "win98": "MSSansSerif",
                "win2k": "Tahoma",
                "winwh": "Tahoma",
                "winxp": "Tahoma",
                "winlh-4093": "Tahoma",
                "winvista": "SegoeUI_9pt",
                "win7": "SegoeUI_9pt",
                "win8": "SegoeUI_9pt",
                "win10": "SegoeUI_9pt",
                "win11": "SegoeUI_9pt"
            }



            isCJ = (text) => {
                if (!text) return false;
                const ChineseRegex = new RegExp(String.raw`
                [\u{FA0E}\u{FA0F}\u{FA11}\u{FA13}\u{FA14}\u{FA1F}\u{FA21}\u{FA23}\u{FA24}\u{FA27}-\u{FA29}]
                |[\u{3000}-\u{303F}]
                |[\u{4E00}-\u{9FCC}]
                |[\u{3400}-\u{4DB5}]
                |[\u{20000}-\u{2A6D6}]
                |[\u{2A700}-\u{2B734}]
                |[\u{2B740}-\u{2B81D}]
                |[\u{2B820}-\u{2CEAF}]
                |[\u{2CEB0}-\u{2EBEF}]
                `.replace(/\s+/g, ''), "u");
                const JapaneseRegex = /[‰∏Ä-Èæ†]+|[„ÅÅ-„Çî]+|[„Ç°-„É¥„Éº]+|[ÔΩÅ-ÔΩöÔº°-Ôº∫Ôºê-Ôºô]+|[„ÄÖ„ÄÜ„Ä§„É∂]+/u;
                for (let regex of [ChineseRegex, JapaneseRegex]) {
                    if (text.match(regex)) {
                        return true;
                    } else {
                        continue;
                    }
                }
                return false;
            }

            testBitmaps = (content, isBold = false, isLarge = false, vgasysr = false) => {
                let fontface = sysFontObj[sys.value];
                if (isLarge) fontface = "SegoeUI_11pt";
                if (vgasysr) fontface = "vgasysr"
                if (sys.value == "winxp" && isBold) fontface = "TrebuchetMS";
                let chars = content.split("");
                if (chars[chars.length - 1] == "") chars.pop();
                let charsWidth = 0;
                if (sys.value == "win1") {
                    for (let char of chars) {
                        charsWidth += 8;
                    }
                    return charsWidth;
                }
                let charsInfo;
                let initFontFace = fontface;
                for (const char of chars) {
                    // CJ
                    if (["win95", "win98", "win2k", "winwh", "winxp", "winlh-4093"].includes(sys.value) && !isBold && isCJ(char)) {
                        fontface = "SimSun";
                        charsInfo = fonts["SimSun"]["regular"]["black"].info;
                    } else if (["winvista", "win7", "win8", "win10", "win11"].includes(sys.value) && !isBold && isCJ(char)) {
                        fontface = "MSUIGothic";
                        charsInfo = fonts["MSUIGothic"]["regular"]["black"].info;
                    } else if (!isCJ(char)) {
                        fontface = initFontFace;
                        charsInfo = fonts[fontface][isBold ? "bold" : "regular"][Object.keys(fonts[fontface][isBold ? "bold" : "regular"])[0]].info;
                    }
                    let addPx = 1;
                    if (fontface == "TrebuchetMS") addPx = 0;
                    if (fontface == "SegoeUI_11pt") addPx = 2;
                    charsWidth += charsInfo[char.charCodeAt(0)].w + addPx;
                }
                return charsWidth;
            }

            ui();
        });

        async function ui() {
            let btn1Rec = document.querySelector("#btn1-rec");
            let btn2Rec = document.querySelector("#btn2-rec");
            let btn3Rec = document.querySelector("#btn3-rec");
            let btn1Dis = document.querySelector("#btn1-dis");
            let btn2Dis = document.querySelector("#btn2-dis");
            let btn3Dis = document.querySelector("#btn3-dis");
            let dl = document.querySelector(".dl");

            // basically the windows error message cannot have 2 or more recommended buttons
            // also a button cannot be disabled and recommended at the same time
            btn1Rec.addEventListener("input", e => {
                if (e.target.checked) {
                    btn2Rec.checked = false;
                    btn2Rec.disabled = true;
                    btn1Dis.checked = false;
                    btn1Dis.disabled = true;
                    if (!document.querySelector("#btn3").disabled) {
                        btn3Rec.checked = false;
                        btn3Rec.disabled = true;
                    }
                } else {
                    btn2Rec.disabled = false;
                    btn1Dis.disabled = false;
                    if (!document.querySelector("#btn3").disabled) {
                        btn3Rec.checked = false;
                        btn3Rec.disabled = false;
                    }
                }
            });

            btn2Rec.addEventListener("input", e => {
                if (e.target.checked) {
                    btn1Rec.checked = false;
                    btn1Rec.disabled = true;
                    btn2Dis.checked = false;
                    btn2Dis.disabled = true;
                    if (!document.querySelector("#btn3").disabled) {
                        btn3Rec.checked = false;
                        btn3Rec.disabled = true;
                    }
                } else {
                    btn1Rec.disabled = false;
                    btn2Dis.disabled = false;
                    if (!document.querySelector("#btn3").disabled) {
                        btn3Rec.checked = false;
                        btn3Rec.disabled = false;
                    }
                }
            });

            btn3Rec.addEventListener("input", e => {
                if (e.target.checked) {
                    btn1Rec.checked = false;
                    btn1Rec.disabled = true;
                    btn2Rec.checked = false;
                    btn2Rec.disabled = true;
                    btn3Dis.checked = false;
                    btn3Dis.disabled = true;
                } else {
                    btn1Rec.disabled = false;
                    btn2Rec.disabled = false;
                    btn3Dis.disabled = false;
                }
            });

            // loading the features the generator can or can't provide for the os
            // e.g. frame recoloring for windows 8 or inability to add button 3 for windows 1.0
            function getSysInfo(system) {
                let iconSys = sys.value;
                if (iconSys == "winmem") iconSys = "win95";
                if (iconSys == "winvista") iconSys = "win7";
                let iconsCount = Object.keys(assetsArray[iconSys].assets).filter(i => i.startsWith("i-")).length;
                document.querySelector("#icon").max = iconsCount;
                let btn1 = document.querySelector("#btn1").value;
                let btn2 = document.querySelector("#btn2").value;
                let btn3 = document.querySelector(".btn3");
                let cross = document.querySelector("#cross");
                let frameColor = document.querySelector("#frame-color");
                let gradients = document.querySelector("#gradient-primary");

                if (system.button3Allowed) {
                    document.querySelector("#btn1").value = btn1;
                    document.querySelector("#btn2").value = btn2;
                    btn3.style.cursor = "default";
                    btn3Dis.disabled = false;
                    btn3Rec.disabled = false;
                    document.querySelector("#btn3").disabled = false;
                    document.querySelectorAll(".btn3 label").forEach(e => {
                        e.style.cursor = "default", e.classList.remove("disabled-label");
                    })
                } else {
                    btn3.style.cursor = "not-allowed";
                    btn3Dis.disabled = true;
                    btn3Rec.disabled = true;
                    document.querySelector("#btn3").value = "";
                    document.querySelector("#btn3").disabled = true;
                    document.querySelectorAll(".btn3 label").forEach(e => {
                        e.style.cursor = "not-allowed";
                        e.classList.add("disabled-label");
                    })
                }

                if (system.cross && !cross) {
                    document.querySelector(".cross-wrapper").innerHTML += `<input type="checkbox" id="cross"><label for="cross">${translatedKeys["x-dis"]}</label><br>`;
                } else if (!system.cross && cross) {
                    document.querySelector(".cross-wrapper").innerHTML = "";
                }

                let colors = {
                    "win95": { p: "#000080", s: "#000080" },
                    "winmem": { p: "#000080", s: "#000000" },
                    "win98": { p: "#000080", s: "#1084d0" },
                    "win2k": { p: "#0a246a", s: "#a6caf0" }
                }

                if (system.recolor && !frameColor) {
                    document.querySelector(".color").innerHTML = `<label for="frame-color">${translatedKeys["frame-color"]}:</label><input type="color" id="frame-color" value="#f0c869">`;
                    document.querySelector(".clr").innerHTML += "<br>";
                } else if (!system.recolor && frameColor) {
                    document.querySelector(".color").innerHTML = "";
                    document.querySelector(".clr").innerHTML = document.querySelector(".clr").innerHTML.replace("<br>", "");
                }

                if (system.gradient && !gradients) {
                    document.querySelector(".gradient-selectors").innerHTML = `<label for="gradient-primary" id="go-up">${translatedKeys["gradient-primary"]}:</label><input type="color" id="gradient-primary" value="${colors[sys.value].p}"><br><br><label for="gradient-sec" id="go-up">${translatedKeys["gradient-sec"]}:</label><input type="color" id="gradient-sec" value="${colors[sys.value].s}">`;
                    document.querySelector(".gradient-selectors").innerHTML += "<br><br>";
                } else if (!system.gradient && gradients) {
                    document.querySelector(".gradient-selectors").innerHTML = "";
                }

                let sysName = system.name;
                if (["win95", "winmem", "win98", "win2k"].includes(sysName)) sysName = "win9x";
                if (sysName == "win10") {
                    sysName = "win8";
                }
                if (sysName == "winvista") {
                    sysName = "win7";
                }
            }

            // when you load the page, windows 1.0 is set by default
            getSysInfo(systems["win1"]);

            // once you select the os, the settings are getting tweaked a bit with the getSysInfo() function
            sys.addEventListener("change", async (e) => {
                getSysInfo(systems[e.target.value]);
            });

            // There we go. The code that does the thing
            async function generateHandler() {
                dl.style.display = "none";
                let e = document.querySelector(".error-txt");

                generate.disabled = true;
                generate.innerHTML = translatedKeys["loading"];

                let title = document.querySelector("#err-title").value;
                let content = document.querySelector("#err-desc").value;
                let icon = document.querySelector("#icon").value;
                let btn1 = document.querySelector("#btn1").value;
                let btn1Dis = document.querySelector("#btn1-dis").checked;
                let btn2 = document.querySelector("#btn2").value;
                let btn2Dis = document.querySelector("#btn2-dis").checked;
                let btn3 = document.querySelector("#btn3").value;
                let btn3Dis = document.querySelector("#btn3-dis").checked;
                let cross = document.querySelector("#cross");
                if (cross) cross = cross.checked;
                let frameColor = document.querySelector("#frame-color");
                if (frameColor) frameColor = frameColor.value;

                let gradientPrimaryColor = document.querySelector("#gradient-primary");
                if (gradientPrimaryColor) gradientPrimaryColor = gradientPrimaryColor.value;
                let gradientSecondaryColor = document.querySelector("#gradient-sec");
                if (gradientSecondaryColor) gradientSecondaryColor = gradientSecondaryColor.value;

                let system = sys.value;

                let fixBtns = ["win7", "win8", "win10", "win11"];
                let bt1 = fixBtns.includes(system) ? { name: btn3, disabled: btn3Dis, rec: btn3Rec.checked } : { name: btn1, disabled: btn1Dis, rec: btn1Rec.checked };
                let bt3 = fixBtns.includes(system) ? { name: btn1, disabled: btn1Dis, rec: btn1Rec.checked } : { name: btn3, disabled: btn3Dis, rec: btn3Rec.checked };

                // if a user is offline, throw an error
                // because the icon for the error is being loaded from the server
                if (!navigator.onLine) {
                    generate.disabled = false;
                    generate.innerHTML = translatedKeys["btn-generate"];
                    return e.innerHTML = translatedKeys["check-internet-connection"];
                }
                e.innerHTML = "";

                await createError(system, title, content, icon, bt1, {
                    name: btn2,
                    disabled: btn2Dis,
                    rec: btn2Rec.checked
                }, bt3, cross, frameColor, gradientPrimaryColor, gradientSecondaryColor)
                    .catch(t => {
                        e.innerHTML = `${t}<br><br>`;
                        console.error(t);
                        generate.disabled = false;
                        generate.innerHTML = translatedKeys["btn-generate"];
                    })
                    .then(() => {
                        generate.disabled = false;
                        generate.innerHTML = translatedKeys["btn-generate"];
                        setTimeout(() => {
                            document.querySelector(".dl").href = document.querySelector("#canvas").toDataURL();
                            dl.style.display = "inline";
                        }, 10)
                    });
            }

            generate.addEventListener("click", generateHandler);
            document.onkeydown = async (e) => {
                // did you know that you can simply hit "enter" to generate the error?
                if (["Enter", "NumpadEnter"].includes(e.code)) {
                    await generateHandler();
                }
            };

            // adding a download button
            dl.addEventListener("click", () => {
                let url = dl.href;
                let a = document.createElement('a');
                a.download = 'err.png';
                a.href = url;
                // sometimes when you download the error message on mobile, it fails for literally no reason
                // so to prevent that, a new tab is being opened, so that you can hold the image and download it successfully
                a.click();
            });
        }

    </script>
    <script src="createError.js"></script>
</body>

</html>